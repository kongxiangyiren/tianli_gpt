(function(m){typeof define=="function"&&define.amd?define(m):m()})(function(){"use strict";console.log(`
 %c Post-Abstract-AI 开源博客文章摘要AI生成工具 %c https://github.com/zhheo/Post-Abstract-AI 
`,"color: #fadfa3; background: #030307; padding:5px 0;","background: #fadfa3; padding:5px 0;");function m(e){var s=!1;function a(t){T();const n=document.querySelector(t);if(!n)return;const l=document.createElement("div");l.className="post-TianliGPT";const r=document.createElement("div");r.className="tianliGPT-title",l.appendChild(r);const i=document.createElement("i");i.className="tianliGPT-title-icon",r.appendChild(i),i.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="48px" height="48px" viewBox="0 0 48 48">
    <title>机器人</title>
    <g id="&#x673A;&#x5668;&#x4EBA;" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
      <path d="M34.717885,5.03561087 C36.12744,5.27055371 37.079755,6.60373651 36.84481,8.0132786 L35.7944,14.3153359 L38.375,14.3153359 C43.138415,14.3153359 47,18.1768855 47,22.9402569 L47,34.4401516 C47,39.203523 43.138415,43.0650727 38.375,43.0650727 L9.625,43.0650727 C4.861585,43.0650727 1,39.203523 1,34.4401516 L1,22.9402569 C1,18.1768855 4.861585,14.3153359 9.625,14.3153359 L12.2056,14.3153359 L11.15519,8.0132786 C10.920245,6.60373651 11.87256,5.27055371 13.282115,5.03561087 C14.69167,4.80066802 16.024865,5.7529743 16.25981,7.16251639 L17.40981,14.0624532 C17.423955,14.1470924 17.43373,14.2315017 17.43948,14.3153359 L30.56052,14.3153359 C30.56627,14.2313867 30.576045,14.1470924 30.59019,14.0624532 L31.74019,7.16251639 C31.975135,5.7529743 33.30833,4.80066802 34.717885,5.03561087 Z M38.375,19.4902885 L9.625,19.4902885 C7.719565,19.4902885 6.175,21.0348394 6.175,22.9402569 L6.175,34.4401516 C6.175,36.3455692 7.719565,37.89012 9.625,37.89012 L38.375,37.89012 C40.280435,37.89012 41.825,36.3455692 41.825,34.4401516 L41.825,22.9402569 C41.825,21.0348394 40.280435,19.4902885 38.375,19.4902885 Z M14.8575,23.802749 C16.28649,23.802749 17.445,24.9612484 17.445,26.3902253 L17.445,28.6902043 C17.445,30.1191812 16.28649,31.2776806 14.8575,31.2776806 C13.42851,31.2776806 12.27,30.1191812 12.27,28.6902043 L12.27,26.3902253 C12.27,24.9612484 13.42851,23.802749 14.8575,23.802749 Z M33.1425,23.802749 C34.57149,23.802749 35.73,24.9612484 35.73,26.3902253 L35.73,28.6902043 C35.73,30.1191812 34.57149,31.2776806 33.1425,31.2776806 C31.71351,31.2776806 30.555,30.1191812 30.555,28.6902043 L30.555,26.3902253 C30.555,24.9612484 31.71351,23.802749 33.1425,23.802749 Z" id="&#x5F62;&#x72B6;&#x7ED3;&#x5408;" fill="#444444" fill-rule="nonzero"></path>
    </g>
    </svg>`;const o=document.createElement("div");o.className="tianliGPT-title-text",o.textContent="AI摘要",r.appendChild(o);const p=document.createElement("div");p.className="tianliGPT-tag",p.id="tianliGPT-tag",p.textContent="TianliGPT",r.appendChild(p);const d=document.createElement("div");d.className="tianliGPT-explanation",d.innerHTML='生成中...<span class="blinking-cursor"></span>',l.appendChild(d),n.insertBefore(l,n.firstChild)}function T(){var n;const t=document.querySelector(".post-TianliGPT");t&&((n=t.parentElement)==null||n.removeChild(t))}var f={getTitleAndContent:function(){try{const t=document.title,n=document.querySelector(tianliGPT_postSelector);if(!n)return console.warn("TianliGPT：找不到文章容器。请尝试将引入的代码放入到文章容器之后。如果本身没有打算使用摘要功能可以忽略此提示。"),"";const l=n.getElementsByTagName("p"),r=n.querySelectorAll("h1, h2, h3, h4, h5");let i="";for(let u of r)i+=u.innerText+" ";for(let u of l){const g=u.innerText.replace(/https?:\/\/[^\s]+/g,"");i+=g}const o=t+" "+i;let p=1e3;return typeof tianliGPT_wordLimit<"u"&&(p=tianliGPT_wordLimit),o.slice(0,p)}catch(t){return console.error("TianliGPT错误：可能由于一个或多个错误导致没有正常运行，原因出在获取文章容器中的内容失败，或者可能是在文章转换过程中失败。",t),""}},fetchTianliGPT:async function(t){if(!tianliGPT_key)return"没有获取到key，代码可能没有安装正确。如果你需要在tianli_gpt文件引用前定义tianliGPT_key变量。详细请查看文档。";if(tianliGPT_key==="5Q5mpqRK5DkwT1X9Gi5e")return"请购买 key 使用，如果你能看到此条内容，则说明代码安装正确。";var n=window.location.href;const l=document.title,r=`https://summary.tianli0.top/?content=${encodeURIComponent(t)}&key=${encodeURIComponent(tianliGPT_key)}&url=${encodeURIComponent(n)}&title=${encodeURIComponent(l)}`,i=2e4;try{const o=new AbortController,p=setTimeout(()=>o.abort(),i),d=await fetch(r,{signal:o.signal});if(d.ok){const u=await d.json();return{summary:u.summary,audioId:u.id}}else throw d.status===402&&document.querySelectorAll(".post-TianliGPT").forEach(u=>{u.style.display="none"}),new Error("TianliGPT：余额不足，请充值后请求新的文章")}catch(o){return o.name==="AbortError"?window.location.hostname==="localhost"?(console.warn("警告：请勿在本地主机上测试 API 密钥。"),"获取文章摘要超时。请勿在本地主机上测试 API 密钥。"):(console.error("请求超时"),"获取文章摘要超时。当你出现这个问题时，可能是key或者绑定的域名不正确。也可能是因为文章过长导致的 AI 运算量过大，您可以稍等一下然后刷新页面重试。"):(console.error("请求失败：",o),"获取文章摘要失败，请稍后再试。")}},aiShowAnimation:function(t=""){const n=document.querySelector(".tianliGPT-explanation");if(!n||s)return;if(typeof tianliGPT_typingAnimate<"u"&&!tianliGPT_typingAnimate){n.innerHTML=t;return}s=!0;const l=25,r=6;n.style.display="block",n.innerHTML='生成中...<span class="blinking-cursor"></span>';let i=!0,o=0,p=!0,d=performance.now();const u=()=>{if(o<t.length&&i){const y=performance.now(),P=y-d,C=t.slice(o,o+1),G=/[，。！、？,.!?]/.test(C)?l*r:l;P>=G&&(n.innerText=t.slice(0,o+1),d=y,o++,o<t.length?n.innerHTML=t.slice(0,o)+'<span class="blinking-cursor"></span>':(n.innerHTML=t,n.style.display="block",s=!1,g.disconnect())),requestAnimationFrame(u)}},g=new IntersectionObserver(y=>{i=y[0].isIntersecting,i&&p&&setTimeout(()=>{requestAnimationFrame(u)},200)},{threshold:0});let w=document.querySelector(".post-TianliGPT");w&&g.observe(w)}};function v(){a(tianliGPT_postSelector);const t=f.getTitleAndContent();t&&console.log("TianliGPT本次提交的内容为："+t),f.fetchTianliGPT(t).then(n=>{const l=n.summary,r=n.audioId,i=document.querySelector(".tianliGPT-tag");i&&(i.dataset.audioId=r,f.aiShowAnimation(l))})}function L(){if(typeof tianliGPT_postURL>"u"){v();return}try{const t=i=>new RegExp("^"+i.split(/\*+/).map(n).join(".*")+"$"),n=i=>i.replace(/[|\\{}()[\]^$+*?.]/g,"\\{{input}}"),l=t(tianliGPT_postURL),r=window.location.href;l.test(r)?v():console.log("TianliGPT：因为不符合自定义的链接规则，我决定不执行摘要功能。")}catch(t){console.error("TianliGPT：我没有看懂你编写的自定义链接规则，所以我决定不执行摘要功能",t)}}e?L():document.addEventListener("DOMContentLoaded",function(){L()})}m(!1),document.addEventListener("pjax:complete",function(){m(!0)}),document.addEventListener("click",function(e){const s=e.target;s&&s.classList.contains("tianliGPT-tag")&&h()});var c=null;function h(){if(c&&!c.paused)c.pause();else{if(!c){const a=document.querySelector(".tianliGPT-tag");if(!a)return;const T=a.dataset.audioId;if(!T){console.error("未找到音频 ID");return}const f=`https://summary.tianli0.top/audio?id=${encodeURIComponent(T)}&key=${encodeURIComponent(tianliGPT_key)}`;c=new Audio(f),c.addEventListener("ended",()=>{a.classList.remove("playing")}),c.addEventListener("play",()=>{a.classList.add("playing")}),c.addEventListener("pause",()=>{a.classList.remove("playing")})}setTimeout(()=>{c==null||c.play().catch(a=>{console.error("播放音频失败:",a)})},100)}const e=document.querySelector(".tianliGPT-tag");if(!e)return;e.addEventListener("click",function(){e.classList.toggle("playing")});const s='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1692880829044" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2346" data-darkreader-inline-fill="" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20"><path d="M512 1024a512 512 0 1 0 0-1024 512 512 0 1 0 0 1024z m0-704a192 192 0 1 1 0 384 192 192 0 1 1 0-384z" p-id="2347"></path></svg>';e.classList.contains("playing")?(e.innerHTML=s,e.style.animation="",e.style.color="#ff0000",e.style.backgroundColor="transparent",e.style.padding="0"):(e.innerHTML=s,e.style.animation="",e.style.color="#000000",e.style.backgroundColor="transparent",e.style.padding="0")}document.addEventListener("click",function(e){const s=e.target,a=document.querySelector(".tianliGPT-tag");a&&(a.addEventListener("click",function(){a.classList.toggle("playing")}),(s===a||a.contains(s))&&h())})});
